{% extends 'base.html' %}
{% load static %}
{% block title %}Patient Dashboard{% endblock %}
{% block header %}Patient Dashboard{% endblock %}
{% block content %}
    <div class="card-custom">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>Welcome, {{ user.first_name|default:user.username }}!</h2>
            <div class="small-muted">Last update: <span id="last-update">—</span></div>
        </div>

        <div style="margin-top:18px;display:grid;grid-template-columns: 1fr 320px;gap:18px;align-items:start;">
            <div class="card-custom" style="padding:12px;">
                <h3 style="margin-top:0;">Live Pressure Map</h3>
                <p class="small-muted">This visualization shows the most recent pressure distribution. Red indicates higher pressure. The map updates in real time.</p>
                <div id="pressure-map" style="width:100%;height:420px;border-radius:8px;overflow:hidden;background:#f8fafc;display:flex;align-items:center;justify-content:center;">
                    <div id="heatmapContainer" style="width:100%;height:100%;position:relative"></div>
                </div>
                <div id="legend" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                    <div style="width:160px;height:10px;background:linear-gradient(90deg,#2dd4bf,#f97316,#ef4444);border-radius:4px;"></div>
                    <div class="small-muted">Low</div>
                    <div style="flex:1"></div>
                    <div class="small-muted">High</div>
                </div>
                <div id="reposition-suggestion" style="margin-top:8px;"></div>
            </div>

            <div class="card-custom" style="padding:12px;">
                <h4 style="margin-top:0;">Recent Readings</h4>
                <div id="recent-list" style="max-height:360px;overflow:auto"> 
                    {% for data in recent_data %}
                        <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                            <div>{{ data.sensor_location }}</div>
                            <div {% if data.pressure_value > 100 %}class="text-danger"{% endif %}>{{ data.pressure_value }} mmHg</div>
                        </div>
                    {% empty %}
                        <div class="small-muted">No recent data</div>
                    {% endfor %}
                </div>
                <div style="margin-top:12px;">
                    <a href="{% url 'pressure_data' %}" class="btn btn-primary">View Graph</a>
                    <a href="{% url 'comments' %}" class="btn">Comments</a>
                </div>
            </div>
        </div>

        <div style="margin-top:18px;">
            <h4 style="margin-bottom:8px;">Live Pressure Trend</h4>
            <div class="card-custom" style="padding:12px;">
                <canvas id="pressureChart" style="width:100%;height:220px;"></canvas>
            </div>
        </div>
        </div>

        <div style="margin-top:18px;">
            <h4 style="margin-bottom:8px;">Notifications</h4>
            {% for notification in notifications %}
                <div class="alert alert-warning">
                    <p style="margin:0">{{ notification.message }} <span class="small-muted">— {{ notification.timestamp }}</span></p>
                </div>
            {% empty %}
                <div class="small-muted">No notifications</div>
            {% endfor %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.5/build/heatmap.min.js"></script>
    <script src="{% static 'js/pressure_map.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="{% static 'js/pressure_graph.js' %}"></script>
    <script>
        window.LIVE_GRID_URL = "{% url 'live_grid_json' %}";
        window.LIVE_GRAPH_URL = "{% url 'live_graph_json' %}";
    </script>
{% endblock %}